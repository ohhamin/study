# 트랜잭션

데이터베이스의 상태를 변화시키기 위해 수행하는 작업 단위

작업단위 : 많은 SQL 명령문들을 사람이 정하는 기준에 따라 정하는 것 (여러 쿼리문을 써도 하나의 작업을 위하면 하나의 트랜잭션)

### 트랜잭션의 특징 (ACID)

- 원자성(Atomicity) : 트랜잭션이 DB에 모두 반영되거나, 혹은 전혀 반영되지 않아야 한다.

- 일관성(Consistency) : 트랜잭션의 작업 처리 결과는 항상 일관성 있어야 한다.

- 독립성(Isolation) : 둘 이상의 트랜잭션이 동시에 병행 실행되고 있을 때, 어떤 트랜잭션도 다른 트랜잭션 연산에 끼어들 수 없다.

- 지속성(Durability) : 트랜잭션이 성공적으로 완료되었다면, 결과는 영구적으로 반영되어야 한다.

##### Commit

하나의 트랜잭션이 성공적으로 끝났고, DB가 일관성있는 상태일 때 이를 알려주기 위해 사용하는 연산

##### Rollback

하나의 트랜잭션 처리가 비정상적으로 종료되어 트랜잭션 원자성이 깨진 경우 시작 상태로 롤백

### DBMS

1. 구조
   크게 질의처리기, 저장시스템
   입출력 단위 : 고정 길이의 page 단위로 disk에 읽거나 쓴다.
   저장 공간 : 비휘발성 저장 장치인 disk에 저장, 일부분을 Main Memory에 저장

2. Page Buffer Manager or Buffer Manager
   BDMS의 Storage System에 속하는 모듈 중 하나로, Main Memory에 유지하는 페이지를 관리하는 모듈

3. UNDO
   필요한 이유 : 수정된 Page들이 Buffer 교체 알고리즘에 따라서 디스크에 출력될 수 있음
   버퍼 교체는 트랜잭션과 무관하게 버퍼의 상태에 따라서 결정됨. 이로 인해, 정상적으로 종료되지 않은 트랜잭션이 변경한 페이지들은 원상 복구 되어야 함

4. REDO
   이미 커밋한 트랜잭션의 수정을 재반영하는 복구 작업

### 트랜잭션 격리 수준

트랜잭션에서 일관성 없는 데이터를 허용하도록 하는 수준

##### Isolation level의 필요성

데이터베이스는 ACID 특징과 같이 트랜잭션이 독립적인 수행을 하도록 한다.

따라서 Locking을 통해 토랜잭션이 DB를 다루는 동안 다른 트랜잭션이 관여하지 못하도록 막는 것이 필요함.

하지만 무조건 Locking으로 동시에 수행되는 수많은 트랜잭션들을 순서대로 처리하는 방식으로 구현하게 되면 성능은 떨어지게 될 것이다.

-> 따라서 효율적인 Locking 방법이 필요!

##### Isolation level의 종류

1. Read Uncommitted (레벨0)
   SELECT 문장이 수행되는 동안 해당 데이터에 Shared Lock이 걸리지 않는 계층

2. Read Committed (레벨1)
   SELECT 문장이 수행되는 동안 해당 데이터에 Shared Lock이 걸리는 계층
   Commit이 이루어진 트랜잭션만 조회 가능
   대부분의 SQL 서버가 Default로 사용

3. Repeatable Read (레벨2)
   트랜잭션이 완료될 때까지 SELECT 문장이 사용하는 모든 데이터에 Shared Lock이 걸리는 계층
   트랜잭션이 범위 내에서 조회한 데이터 내용이 항상 동일함을 보장함
   MySQL에서 Default로 사용

4. Serializable (레벨3)
   트랜잭션이 완료될 때까지 SELECT 문장이 사용하는 모든 데이터에 Shared Lock이 걸리는 계층
   완벽한 읽기 일관성 모드를 제공

##### 고려사항

동시성을 증가시키면 데이터 무결성에 문제가 발생하고, 데이터 무결성을 유지하면 동시성이 떨어지게 됨

레벨을 높게 조정할 수록 발생하는 비용이 증가함

##### 낮은 단계를 활용할 때 발생하는 현상

- Dirty Read (레벨 0)
  어떤 트랜잭션에서 아직 실행이 끝나지 않은 다른 트랜잭션에 의한 변경사항을 보게되는 경우

- Non-Repeatable Read (레벨 1 이하)한 트랜잭션에서 같은 쿼리를 두 번 수행할 때 그 사이에 다른 트랜잭션 값을 수정 또는 삭제하면서 두 쿼리의 결과가 상이하게 나타나는 일관성이 깨진 현상

- Phantom Read (레벨 2 이하)
  한 트랜잭션 안에서 일정 범위의 레코드를 두 번 이상 읽었을 때, 첫번째 쿼리에서 없던 레코드가 두번째 쿼리에서 나타나는 현상
